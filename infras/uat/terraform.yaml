tags: { environment: "uat" }
################################################################################
# VPC
################################################################################
vpcs:
  main_vpc:
    name: "fullstack-uat-vpc"
    cidr: "10.2.0.0/16"
    enable_ipv6: false
    instance_tenancy: "default"

    azs: ["ap-southeast-1a", "ap-southeast-1b"]
    public_subnets: ["10.2.1.0/24", "10.2.2.0/24"]
    private_subnets: ["10.2.10.0/24", "10.2.11.0/24"]
    database_subnets: ["10.2.20.0/24", "10.2.21.0/24"]

    enable_nat_gateway: true
    single_nat_gateway: true
    one_nat_gateway_per_az: false

    enable_dns_hostnames: true  
    enable_dns_support: true

################################################################################
# Cloud Map Namespaces
################################################################################
namespaces:
  lab_ns: # Key nội bộ để tham chiếu
    name: "lab"
    vpc_key: "main_vpc"
  prod_ns:
    name: "production"
    vpc_key: "main_vpc"

################################################################################
# ECS Cluster
################################################################################
ecs_clusters:
  ecs_lab:
    name: "uat-ecs-lab"
    vpc_key: "main_vpc" # Key để map với module VPC
    
    # Cấu hình Capacity Provider mặc định
    default_capacity_provider_strategy:
      FARGATE:
        weight: 100

    services:
      # ======================
      # BACKEND SERVICE
      # ======================
      backend:
        cpu: 512
        memory: 1024
        image: "thson20210744/fullstack-backend:dev-10"
        container_port: 80
        port_name: "backend-http"
        rds_reference: "main_db"
        security_group_keys: ["ecs_sg"]
        alb_key: "main_alb"
        secrets:
          - name: "DB_PASSWORD" 
            rds_secret_key: "main_db"
        # Biến môi trường
        environment:
          - name: "ASPNETCORE_ENVIRONMENT"  
            value: "Development"
          - name: "CORS_ALLOWED_ORIGINS"
            value: "ALB_DNS_PLACEHOLDER"
          - name: DB_HOST
            value: "<RDS-ENDPOINT>"
          - name: DB_NAME
            value: DCandidateDB
          - name: DB_USER
            value: admin
          #- name: "ConnectionStrings__DefaultConnection"
          #  value: "server=<RDS-ENDPOINT>;port=3306;database=DCandidateDB;user=admin;password=${DB_PASSWORD};"
        service_connect:
          namespace_key: "lab_ns"
          discovery_name: "backend"
          client_alias_port: 80
          client_alias_dns: "backend"

        # Load Balancer info
        target_group_key: "backend_tg"
        
        # Security Group References
        # (Khai báo key của SG cần allow, Terraform sẽ tự lookup ID)
        ingress_security_group_keys: ["alb"] 

      # ======================
      # FRONTEND SERVICE
      # ======================
      frontend:
        cpu: 512
        memory: 1024
        image: "thson20210744/fullstack-frontend:dev-10"
        container_port: 80
        port_name: "frontend-http"
        security_group_keys: ["ecs_sg"]
        alb_key: "main_alb"
        environment:
          - name: "REACT_APP_API_URL"
            value: "ALB_DNS_PLACEHOLDER/api"

        service_connect:
          namespace_key: "lab_ns"
          discovery_name: "frontend"
          client_alias_port: 80
          client_alias_dns: "frontend"

        target_group_key: "frontend_tg"
        ingress_security_group_keys: ["alb"]

################################################################################
# ALB
################################################################################
albs:
  main_alb:
    load_balancer_type: "application"
    name: "uat-dsq-backend-alb"
    internal: false
    ip_address_type: "ipv4"

    vpc_key: "main_vpc"
    ipam_pools: null
    sg_key: "alb_sg"

    listeners:
      http:
        protocol: "HTTP"
        port: 80

        redirect:
          protocol: "HTTPS"
          port: "443"
          status_code: "HTTP_301"

      https:
        protocol: "HTTPS"
        port: 443
        acm_key: "alb_cert"
        forward:
          target_group_key: "frontend_tg"
        rules:
          api_rule:
            priority: 1
            actions: 
              - forward: 
                  target_group_key: "backend_tg"
            conditions:
              - path_pattern:
                  values: ["/api/*"]
    target_groups:
      frontend_tg:
        name: "tg-frontend"
        target_type: "ip"
        protocol: "HTTP"
        port: 80
        create_attachment: false # QUAN TRỌNG: ECS tự attach
      backend_tg:
        name: "tg-backend"
        target_type: "ip"
        protocol: "HTTP"
        port: 80
        create_attachment: false
    

################################################################################
# 1. RDS - DATABASE
################################################################################
rds_databases:
  main_db:
    identifier: "uat-candidate-db-instance"
    engine: "mysql"
    engine_version: "8.0.37"
    family: "mysql8.0"              # Bắt buộc để tạo Parameter Group [cite: 11]
    major_engine_version: "8.0"     # Bắt buộc để tạo Option Group [cite: 11]
    instance_class: "db.t3.micro"
    allocated_storage: 20
    db_name: "DCandidateDB"
    username: "admin"
    vpc_key: "main_vpc"
    sg_key: "rds_sg"
    port: 3306
    manage_master_user_password: true
    performance_insights_enabled: false
    kms_key_id: "alias/aws/rds"
    db_subnet_group_name: "uat-main-db-subnet-group"
    monitoring_role_name: "uat-rds-monitoring-role"
    performance_insights_enabled: false
    storage_encrypted: true
################################################################################
# Security Group
################################################################################
sgs:
  # Security Group cho Load Balancer (Cửa ngõ)
  alb_sg:
    name: "uat-dsq-alb-sg"
    description: "Security group for ALB"
    vpc_key: "main_vpc"

    ingress_cidr_blocks: ["0.0.0.0/0"]
    ingress_rules: ["http-80-tcp", "https-443-tcp"]
    egress_cidr_blocks: ["0.0.0.0/0"]
    egress_rules: ["all-all"]

  # Security Group cho ECS (Frontend & Backend)
  ecs_sg:
    name: "uat-dsq-ecs-sg"
    description: "Security group for ECS Services"
    vpc_key: "main_vpc"

    egress_cidr_blocks: ["0.0.0.0/0"]
    egress_rules: ["all-all"]

  # Security Group cho RDS (Database)
  rds_sg:
    name: "uat-dsq-rds-sg"
    description: "Security group for RDS Database"
    vpc_key: "main_vpc"

    egress_cidr_blocks: ["0.0.0.0/0"]
    egress_rules: ["all-all"]

sg_rules:
  rule_1:
    # Rule kết nối từ ALB vào các ECS Tasks
    source_sg_key: "alb_sg"
    sg_key: "ecs_sg"
    description: "Allow traffic from ALB to ECS Services"
    type: "ingress"
    protocol: "tcp"
    from_port: 80
    to_port: 80
  rule_2:
    # Rule kết nối từ ECS vào RDS (MySQL/Aurora)
    source_sg_key: "ecs_sg"
    sg_key: "rds_sg"
    description: "Allow MySQL traffic from ECS to RDS"
    type: "ingress"
    protocol: "tcp"
    from_port: 3306
    to_port: 3306
################################################################################
# Zone DNS (Route53) and ACM
################################################################################
route53_zones:
  main_zone:
    name: "sonth40.dpdns.org"

acms:
  alb_cert:
    route53_key: "main_zone"
    domain_name: "sonth40.dpdns.org"
    validation_method: "DNS"

route53_records:
  alb_alias_record:
    name: "uat.sonth40.dpdns.org"
    route53_key: "main_zone"
    records:
      my_alias:
        type: "A"
        alb_key: "main_alb"
        alias: 
          evaluate_target_health: true